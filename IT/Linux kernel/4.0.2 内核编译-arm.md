# ABI
- ABI(application binary interface)：二进制应用程序接口
- EABI，嵌入式ABI

# 交叉编译工具
## 安装ARM交叉编译工具
	sudo apt-get install gcc-arm-linux-gnueabi

## 查看版本
	arm-linux-gnueabi-gcc -v 

## 使用 update-alternatives 命令来对 GCC 工具的多个版本进行管理
```
update-alternatives --install <link> <name> <path> <priority>
- link：指向/etc/alternatives/<name>的符号引用
- name： 链接的名称
- path： 这个命令对应的可执行文件的实际路径
- priority： 优先级， 在 auto 模式下， 数字大的优先级比较高

$ sudo update-alternatives --install /usr/bin/arm-linux-gnueabi-gcc arm-linux-gnueabi-gcc /usr/bin/arm-linux-gnueabi-gcc-5 5
$ sudo update-alternatives --install /usr/bin/arm-linux-gnueabi-gcc arm-linux-gnueabi-gcc /usr/bin/arm-linux-gnueabi-gcc-7 7
$ sudo update-alternatives --config arm-linux-gnueabi-gcc  #设置使用的版本
```
# qemu
## 安装qemu
	sudo apt-get install qemu

## 常用命令
	qemu-system- tab          #查看qemu支持的CPU架构
	qemu-system-arm --version #查看qemu的版本。
	qemu-system-arm -M help   #查看支持的开发板类别。

# 编译内核和设备树
## 下载内核
https://www.kernel.org/
$ tar xvf linux-4.4.232.tar.xz
$ cd linux-4.4.232/

## 配置Makefile。编辑Makefile文件 或者 直接导出
![](../../photo/paste-137c8e103ad3dfa511fa1ff0e92fd71fd0752155.jpg)
	$ export ARCH=arm
	$ export CROSS_COMPILE=arm-linux-gnueabi-

## 选择vexpress系列开发板
	$ make vexpress_defconfig  # ./arch/arm/configs/vexpress_defconfig
	$ make menuconfig             # 编译后生成.config文件

## 编译内核，生成zImage镜像文件
	#zImage生成路径：arch/arm/boot/zImage
	$ make zImage -j6（多线程编译，6个线程）

## 编译内核模块
	$ make modules -j4  # drivers/video/backlight/*.ko

## 编译设备树，获得dtb文件
	$ make dtbs  # arch/arm/boot/dts/vexpress-v2p-ca9.dtb

## 使用qemu运行内核
	$ qemu-system-arm -M vexpress-a9 -m 512M -kernel arch/arm/boot/zImage -dtb arch/arm/boot/dts/vexpress-v2p-ca9.dtb -nographic -append "console=ttyAMA0"
	该命令指定了开发板类别、内存大小、内核zImage文件、设备树dtb文件、无图形界面、串口
	由于还未挂载根文件系统，所以VFS会有报错
	ffe0: 00000000 00000000 00000000 00000000 00000013 00000000
	—[ end Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0) ]
	
# busybox根文件系统制作
[4.1.1 根文件系统](4.1.1%20根文件系统.md)

## 生成虚拟SD卡，制作系统镜像rootfs.ext3(块设备不能直接读写，需要mount)
	$ cd ~
	$ dd if=/dev/zero of=rootfs.ext3 bs=1M count=32 #生成虚拟sd卡，rootfs.ext3
	$ mkfs.ext3 rootfs.ext3                                          #格式化该镜像
	$ mount -t ext3 rootfs.ext3 /mnt -o loop                #将虚拟sd卡挂载到/mnt
	$ cp -r /home/zvcv/rootfs/* /mnt/                           #拷贝rootfs的所有文件到sd卡
	$ umount /mnt                                                       #卸载sd

## 使用qemu运行内核和文件系统
	$ cd linux-4.4.232
	# 非图形化启动，比之前多指定了一个sd镜像
	$ qemu-system-arm -M vexpress-a9 -m 512M -kernel arch/arm/boot/zImage -dtb arch/arm/boot/dts/vexpress-v2p-ca9.dtb -nographic -append "root=/dev/mmcblk0 rw console=ttyAMA0" -sd /home/zvcv/rootfs.ext3
	# 图形化启动
	$ qemu-system-arm -M vexpress-a9 -m 512M -kernel arch/arm/boot/zImage -dtb arch/arm/boot/dts/vexpress-v2p-ca9.dtb -append "root=/dev/mmcblk0 rw console=tty0" -sd /home/zvcv/rootfs.ext3



