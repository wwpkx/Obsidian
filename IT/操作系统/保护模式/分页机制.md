- 在分段机制中，线性地址即物理地址
- 无论是分段还是分页，cpu认为 **虚拟地址/线性地址**是**连续**的
- 页目录表 **PDT**(Page Direcotry Table),  页目录表项 **PDE**(Page Direcotry Entry)
- 页表 **PTT**(Page Table)，  页表项 **PTE**(Page Table Entry)
- 页目录基址寄存器 **PDBR**(Page Direcotry Base Register ), CR3

# 从虚拟地址到物理地址映射
- 计算顺序
	1. CR3 和 线性地址
	2. 页目录表PDT
	3. 页表PTT
	4. 偏移量 和 线性地址
- 
- 找到 **页目录/一级页表 的物理地址**，比如**cr3**、ttbrx
- **页目录项/页表项**，由2部分组成
	 - **地址**：指向下一层
	 - **属性**
- 线性地址拆分，找到 **页目录项/页表项 的索引**
	- 10-10-12  // C:\boot.ini 内容为execute
	- 2-9-9-12  // C:\boot.ini 内容为noexecute
- **根据索引找到表项**，表项中存储的是下一级的物理地址
- **物理地址 = 最后一层页表中找到的物理地址 + 虚拟页表中的偏移量**

# 线性地址计算
![](../../photo/Pasted%20image%2020221216191014.png)

# 10-10-12 分页
- 逻辑地址 --> 虚拟地址/线性地址(32位) --> 物理地址
- **线性地址举例**：MOV eax,dword ptr ds:[0x12345678] //ds.Base+0x12345678是线性地址
- 段标识符:段内偏移量 --> 页式管理地址(10+10+12 == 页目录pde+页表pte+页内偏移量) --> 物理地址
- cr3，1级页表起始位置

![](../../photo/Pasted%20image%2020221216180714.png)
![](../../photo/Pasted%20image%2020221216200737.png)

## PDE 和 PTE 的 属性
![](../../photo/Pasted%20image%2020221216191832.png)
# 2-9-9-12 分页
- 又称为：PAE(物理地址扩展)分页
- 10-10-12分页方式，最大支持4G物理地址 【无法满足】
- 

![](../../photo/Pasted%20image%2020221216194823.png)
分页方式转换方式：
> 1.  根据 CR3 找到 Page Directory Pointer Table
> 2.  根据一级索引在 Page Directory Pointer Table 中查询到 Page Directory
> 3.  根据二级索引在 Page Directory 中查询到 Page Table
> 4.  根据三级索引在 Page Table 中查询到普通 4KB 物理页
> 5.  在物理页中查找第四段偏移

# arm二级页表查询过程
![](../../photo/paste-568966199596a019a70675cb5d9f8c2c1c1980ce.jpg)
# struct page
- linux内核默认4KB，可以配置
- 对应一个struct page，该结构定义page的各种状态，比如free，lock等
![](../../photo/paste-b35dc522a5537bb0284beefb293028d8e338e859.jpg)

# 快表tlb
- 其实就是高速缓冲，目的是为了减少计算物理地址的时间
- 虚拟地址的高20位 直接映射为  物理地址的高20位
- 如果某个页被访问到，则其高20位入表
- 下次在访问该表，直接在快表中访问
- 如果，不在快表中，则通过计算获取物理地址访问
![](../../photo/paste-de80f51f6092665d2c67735457456b3e06702b33.jpg)

# CPU缓存
- CPU缓存是位于CPU与物理内存之间的临时存储器
- 它的**容量比内存小**的多，但是**交换速度却比内存要快**得多。
- CPU缓存可以做的很大，有几K、几十K、几百K甚至上M的也有。

CPU缓存与TLB的区别：
- TLB: 线性地址<->物理地址
- CPU缓存：物理地址<->内容